{"version":3,"file":"index.cjs","sources":["../src/index.js"],"sourcesContent":["'use strict';\n\nimport * as cheerio from 'cheerio';\nimport debugModule from 'debug';\nconst debug = debugModule('metalsmith-safe-links');\nimport { extname } from 'path';\nimport url from 'url';\n\nconst isHTMLFile = (filePath) => {\n  return /\\.html|\\.htm/.test(extname(filePath));\n};\n\n/**\n * Metalsmith plugin to process all site links.\n * \n * Adds a target and rel attribute to all external links and \n * strips the protocol and domain parts of any local link\n * \n *\n * @param  {Object} options\n *   @property {array} hostnames\n */\n\nconst safeLinks = (options) => {\n  options = options || {\n    hostnames: [],\n  };\n\n  if (!options.hostnames.length) {\n    console.log(\"Missing Host Name(s)\");\n    return;\n  }\n\n  const hostnames = options.hostnames;\n\n  return (files, metalsmith, done) => {\n    // Use metalsmith's built-in debug if available\n    const debugFn = metalsmith.debug ? metalsmith.debug('metalsmith-safe-links') : debug;\n    debugFn('Processing links with options: %o', options);\n    \n    setImmediate(done);\n\n    Object.keys(files).forEach(file => {\n      if (!isHTMLFile(file)) {\n        return;\n      }\n\n      const contents = files[file].contents.toString();\n      const $ = cheerio.load(contents, { decodeEntities: false }, true);\n\n      $('a').each(function() {\n        const thisLink = $(this);\n        const linkAttributes = thisLink[0].attribs;\n        const urlString = typeof linkAttributes.href === \"string\" ? url.parse(linkAttributes.href, true) : null;\n\n        // check all links that have a protocol string, this implies that they also have a hostname\n        if (urlString && urlString.protocol) {\n          // check if this url is local\n          if (hostnames.includes(urlString.hostname)) {\n            // strip protocol//hostname from local link \n            debugFn('Converting local link: %s to %s', linkAttributes.href, urlString.pathname);\n            thisLink.attr(\"href\", urlString.pathname);\n          } else {\n            // add target='_blank' and rel='noopener noreferrer' to all external links\n            debugFn('Adding target and rel to external link: %s', linkAttributes.href);\n            thisLink.attr(\"target\", \"_blank\");\n            thisLink.attr(\"rel\", \"noopener noreferrer\");\n          }\n        }\n      });\n\n      files[file].contents = Buffer.from($.html());\n    });\n  };\n};\n\n// ESM export\nexport default safeLinks;\n\n// CommonJS export compatibility\nif (typeof module !== 'undefined') {\n  module.exports = safeLinks;\n}"],"names":["debug","debugModule","isHTMLFile","filePath","test","extname","safeLinks","options","hostnames","length","console","log","files","metalsmith","done","debugFn","setImmediate","Object","keys","forEach","file","contents","toString","$","cheerio","load","decodeEntities","each","thisLink","linkAttributes","attribs","urlString","href","url","parse","protocol","includes","hostname","pathname","attr","Buffer","from","html","module","exports"],"mappings":"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"}